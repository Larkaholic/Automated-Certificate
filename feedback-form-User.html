<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="./src/output.css" rel="stylesheet">
    <title>User Feedback Form</title>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-white">
    <div class="text-3xl font-bold mb-12 text-gray-800 text-center" id="formTitle">
        Feedback Form
    </div>
    <div class="w-full max-w-xl">
        <div class="bg-gray-300 rounded-xl shadow-lg p-8 w-full max-w-xl mx-auto">
            <form class="space-y-8" id="user-feedback-form">
                <!-- Name and Email fields will be inserted here by JS -->
            </form>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script type="module">
        import { app } from "./script/firebase.js";
        const db = firebase.firestore();

        // Get event title from URL
        function getEventFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get("event") || "";
        }

        async function loadQuestions() {
            const eventTitle = getEventFromUrl();
            if (!eventTitle) {
                document.getElementById('formTitle').textContent = "No event specified.";
                return;
            }
            document.getElementById('formTitle').textContent = `Feedback Form for "${eventTitle}"`;
            const form = document.getElementById('user-feedback-form');
            form.innerHTML = `
                <div>
                    <label class="block text-xl font-medium mb-2 text-gray-800">Name</label>
                    <input type="text" name="participantName" class="w-full px-4 py-2 bg-gray-200 border-b border-gray-400 focus:outline-none rounded" required />
                </div>
                <div>
                    <label class="block text-xl font-medium mb-2 text-gray-800">Email</label>
                    <input type="email" name="participantEmail" class="w-full px-4 py-2 bg-gray-200 border-b border-gray-400 focus:outline-none rounded" required />
                </div>
            `;
            try {
                const doc = await db.collection("events").doc(eventTitle).get();
                if (!doc.exists) {
                    form.innerHTML += "<div class='text-red-600'>No questions found for this event.</div>";
                    return;
                }
                const questions = doc.data().questions || [];
                questions.forEach((q, idx) => {
                    let html = `<div>`;
                    html += `<label class="block text-xl font-medium mb-2 text-gray-800">${idx + 1}. ${q.text}</label>`;
                    if (q.type === "rating") {
                        html += `<div class="flex flex-row space-x-4">`;
                        for (let i = 1; i <= 5; i++) {
                            html += `<label><input type="radio" name="q${idx}" value="${i}" class="mr-2">${i}</label>`;
                        }
                        html += `</div>`;
                    } else {
                        html += `<input type="text" name="q${idx}" class="w-full px-4 py-2 bg-gray-200 border-b border-gray-400 focus:outline-none rounded" />`;
                    }
                    html += `</div>`;
                    form.innerHTML += html;
                });
                form.innerHTML += `<div class="flex justify-center pt-4">
                    <button type="submit"
                        class="w-1/3 bg-white text-black font-medium py-2 rounded-lg hover:bg-gray-500 transition-colors">Submit</button>
                </div>`;
            } catch (err) {
                form.innerHTML += `<div class='text-red-600'>Error loading questions: ${err.message}</div>`;
            }
        }

        document.getElementById('user-feedback-form').onsubmit = async function(e) {
            e.preventDefault();
            const eventTitle = getEventFromUrl();
            const form = e.target;
            const name = form.participantName.value.trim();
            const email = form.participantEmail.value.trim();
            const answers = [];
            const doc = await db.collection("events").doc(eventTitle).get();
            const questions = doc.exists ? (doc.data().questions || []) : [];
            questions.forEach((q, idx) => {
                let answer;
                if (q.type === "rating") {
                    answer = form[`q${idx}`]?.value || "";
                } else {
                    answer = form[`q${idx}`]?.value || "";
                }
                answers.push({
                    question: q.text,
                    answer: answer
                });
            });
            // Save to Firestore
            await db.collection("events").doc(eventTitle).collection("responses").add({
                name,
                email,
                answers,
                submittedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert('Thank you for your feedback!');
            form.reset();
        };

        loadQuestions();
    </script>
</body>
</html>
